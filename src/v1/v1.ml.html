<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>v1.ml</title>
<meta name="generator" content="emacs 26.3; htmlfontify 0.21" />
<style type="text/css"><!-- 
body { font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  color: #232627;  background: #fcfcfc;  font-size: 15pt;  text-decoration: none; }
span.default   { font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  color: #232627;  background: #fcfcfc;  font-size: 15pt;  text-decoration: none; }
span.default a { font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  color: #232627;  background: #fcfcfc;  font-size: 15pt;  text-decoration: underline; }
span.string   { color: #8b2252;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: none; }
span.string a { color: #8b2252;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: underline; }
span.label   { color: #008b8b;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: none; }
span.label a { color: #008b8b;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: underline; }
span.constant   { color: #008b8b;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: none; }
span.constant a { color: #008b8b;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: underline; }
span.constructor   { font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  color: #232627;  background: #fcfcfc;  font-size: 15pt;  text-decoration: none; }
span.constructor a { font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  color: #232627;  background: #fcfcfc;  font-size: 15pt;  text-decoration: underline; }
span.builtin   { color: #483d8b;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: none; }
span.builtin a { color: #483d8b;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: underline; }
span.tuareg-font-double-colon-face   { color: #ff4500;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: none; }
span.tuareg-font-double-colon-face a { color: #ff4500;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: underline; }
span.keyword   { color: #a020f0;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: none; }
span.keyword a { color: #a020f0;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: underline; }
span.attribute   { color: #483d8b;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: none; }
span.attribute a { color: #483d8b;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: underline; }
span.variable-name   { color: #a0522d;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: none; }
span.variable-name a { color: #a0522d;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: underline; }
span.function-name   { color: #0000ff;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: none; }
span.function-name a { color: #0000ff;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: underline; }
span.comment   { color: #b22222;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: none; }
span.comment a { color: #b22222;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: underline; }
span.comment-delimiter   { color: #b22222;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: none; }
span.comment-delimiter a { color: #b22222;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: underline; }
span.type   { color: #228b22;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: none; }
span.type a { color: #228b22;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: underline; }
span.operator   { color: #a52a2a;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: none; }
span.operator a { color: #a52a2a;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: underline; }
span.module   { color: #228b22;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: none; }
span.module a { color: #228b22;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: underline; }
span.governing   { color: #000000;  font-weight: 700;  font-family: Ubuntu Mono;  font-stretch: normal;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: none; }
span.governing a { color: #000000;  font-weight: 700;  font-family: Ubuntu Mono;  font-stretch: normal;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: underline; }
span.doc   { color: #8b2252;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: none; }
span.doc a { color: #8b2252;  font-family: Ubuntu Mono;  font-stretch: normal;  font-weight: 500;  font-style: normal;  background: #fcfcfc;  font-size: 15pt;  text-decoration: underline; }
 --></style>

    <script type="text/javascript"><!--
  // this function is needed to work around
  // a bug in IE related to element attributes
  function hasClass(obj)
  {
      var result = false;
      if (obj.getAttributeNode("class") != null)
      {
          result = obj.getAttributeNode("class").value;
      }
      return result;
  }

  function stripe(id)
  {
      // the flag we'll use to keep track of
      // whether the current row is odd or even
      var even = false;

      // if arguments are provided to specify the colors
      // of the even & odd rows, then use them;
      // otherwise use the following defaults:
      var evenColor = arguments[1] ? arguments[1] : "#fff";
      var oddColor  = arguments[2] ? arguments[2] : "#ddd";

      // obtain a reference to the desired table
      // if no such table exists, abort
      var table = document.getElementById(id);
      if (! table) { return; }

      // by definition, tables can have more than one tbody
      // element, so we'll have to get the list of child
      // &lt;tbody&gt;s
      var tbodies = table.getElementsByTagName("tbody");

      // and iterate through them...
      for (var h = 0; h < tbodies.length; h++)
      {
          // find all the &lt;tr&gt; elements...
          var trs = tbodies[h].getElementsByTagName("tr");

          // ... and iterate through them
          for (var i = 0; i < trs.length; i++)
          {
              // avoid rows that have a class attribute
              // or backgroundColor style
              if (! hasClass(trs[i]) &&
                  ! trs[i].style.backgroundColor)
              {
                  // get all the cells in this row...
                  var tds = trs[i].getElementsByTagName("td");

                  // and iterate through them...
                  for (var j = 0; j < tds.length; j++)
                  {
                      var mytd = tds[j];

                      // avoid cells that have a class attribute
                      // or backgroundColor style
                      if (! hasClass(mytd) &&
                          ! mytd.style.backgroundColor)
                      {
                          mytd.style.backgroundColor =
                            even ? evenColor : oddColor;
                      }
                  }
              }
              // flip from odd to even, or vice-versa
              even =  ! even;
          }
      }
  }

  function toggle_invis( name )
  {
      var filter =
        { acceptNode:
          function( node )
          { var classname = node.id;
            if( classname )
            { var classbase = classname.substr( 0, name.length );
              if( classbase == name ) { return NodeFilter.FILTER_ACCEPT; } }
            return NodeFilter.FILTER_SKIP; } };
      var walker = document.createTreeWalker( document.body           ,
                                              NodeFilter.SHOW_ELEMENT ,
                                              filter                  ,
                                              false                   );
      while( walker.nextNode() )
      {
          var e = walker.currentNode;
          if( e.style.display == "none" ) { e.style.display = "inline"; }
          else                            { e.style.display = "none";   }
      }
  }
--> </script>
  </head>
  <body onload="stripe('index'); return true;">

<pre><span class="doc">(** V1 - implement directories and file metadata, with file data
   passed through to an underlying filesystem.

We have a single &quot;global object map&quot;, which maps ids (ints) to either
   dir-roots, or file-meta, or symlinks.

NOTE</span><span class="doc"> much of this is based on {!Tjr_minifs.In_mem}, but with on-disk</span><span class="doc">
</span><span class="doc">   maps, rather than in-memory. *)</span>

<span class="governing">open </span><span class="module">Tjr_monad.With_lwt</span>
<span class="governing">open </span><span class="module">Std_types</span>
<span class="governing">open </span><span class="module">Bin_prot.Std</span>
<span class="governing">module</span> <span class="module">G</span> <span class="operator">=</span> <span class="module">Generic</span>
<span class="governing">open </span><span class="module">G</span>

<span class="governing">type</span> <span class="operator">(</span><span class="type">'k</span><span class="operator">,</span><span class="type">'v</span><span class="operator">,</span><span class="type">'t</span><span class="operator">)</span><span class="type"> </span><span class="type">uncached_btree</span> <span class="operator">=</span> <span class="operator">(</span>'k<span class="operator">,</span>'v<span class="operator">,</span>'t<span class="operator">)</span><span class="module">Tjr_btree.Make_3.</span>uncached_btree

<span class="comment-delimiter">(* </span><span class="comment">FIXME move to std_types </span><span class="comment-delimiter">*)</span>
<span class="governing">let</span> <span class="function-name">buf_create</span><span class="variable-name"> </span><span class="operator">()</span> <span class="operator">=</span> buf_ops.create <span class="operator">(</span><span class="module">Blk_sz.</span>to_int blk_sz<span class="operator">)</span>

<span class="governing">let</span> <span class="function-name">s256_to_string</span><span class="variable-name"> </span><span class="operator">(</span><span class="variable-name">s</span><span class="operator">:</span><span class="type">str_256</span><span class="operator">)</span> <span class="operator">=</span> <span class="operator">(</span>s <span class="operator">:&gt;</span><span class="type"> string</span><span class="operator">)</span>

<span class="doc">(** {2 Setup the ge</span><span class="doc">neric instance} *)</span>

<span class="doc">(** Base types *)</span>
<span class="governing">module</span> <span class="module">S0</span> <span class="operator">=</span> <span class="governing">struct</span>
  <span class="governing">type</span> <span class="type">t</span> <span class="operator">=</span> lwt
  <span class="governing">let</span> <span class="variable-name">monad_ops</span> <span class="operator">=</span> monad_ops
  <span class="governing">type</span> <span class="type">fid</span> <span class="operator">=</span> <span class="operator">{</span>fid<span class="operator">:</span>int<span class="operator">}</span><span class="attribute">[@@deriving bin_io]</span>
  <span class="governing">type</span> <span class="type">did</span> <span class="operator">=</span> <span class="operator">{</span>did<span class="operator">:</span>int<span class="operator">}</span><span class="attribute">[@@deriving bin_io]</span>
  <span class="governing">type</span> <span class="type">sid</span> <span class="operator">=</span> <span class="operator">{</span>sid<span class="operator">:</span>int<span class="operator">}</span><span class="attribute">[@@deriving bin_io]</span>
<span class="governing">end</span>
<span class="governing">open </span><span class="module">S0</span>

<span class="governing">module</span> <span class="module">Make</span> <span class="operator">=</span> <span class="module">G.Make</span><span class="operator">(</span><span class="module">S0</span><span class="operator">)</span>

<span class="doc">(** derived types *)</span>
<span class="governing">module</span> <span class="module">S1</span> <span class="operator">=</span> <span class="module">Make.S1</span>
<span class="governing">open </span><span class="module">S1</span>

<span class="doc">(** functor argument type holder *)</span>
<span class="governing">module</span> <span class="module">S2</span> <span class="operator">=</span> <span class="module">Make.S2</span>

<span class="doc">(** what we need to provide to get a filesystem *)</span>
<span class="governing">module</span> <span class="governing">type</span> <span class="module">T2</span> <span class="operator">=</span> <span class="module">S2.T2</span>

<span class="doc">(** functor to construct a filesystem (takes a module of type T2); the
   implementation is {!T2_impl}, towards the end of this file *)</span>
<span class="governing">module</span> <span class="module">Make_2</span> <span class="operator">=</span> <span class="module">Make.Make_2</span>

<span class="doc">(** {2 Some simple defns we can complete here} *)</span>

<span class="governing">let</span> <span class="variable-name">root_did</span> <span class="operator">=</span> <span class="operator">{</span>did<span class="operator">=</span>0<span class="operator">}</span>

<span class="governing">let</span> <span class="function-name">mk_stat_times</span><span class="variable-name"> </span><span class="operator">()</span> <span class="operator">=</span> 
  <span class="module">Unix.</span>time <span class="operator">()</span> <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">t</span> <span class="operator">-&gt;</span> <span class="comment-delimiter">(* </span><span class="comment">1s resolution? FIXME </span><span class="comment-delimiter">*)</span>
  return <span class="operator">{</span> st_atim<span class="operator">=</span>t<span class="operator">;</span> st_mtim<span class="operator">=</span>t <span class="operator">}</span>



<span class="doc">(** {2 Implement definitions from T2, ie, the core filesystem} *)</span>

<span class="governing">type</span> <span class="type">obj_root</span> <span class="operator">=</span> blk_id  <span class="attribute">[@@deriving bin_io]</span>

<span class="comment-delimiter">(*</span><span class="comment">
module Dir_entry = struct
  (* open Str_256 *)
  (** NOTE again, could just use a plain blk_id/int and drop the constructors *)
  type dir_entry = 
    | F of obj_root
    | D of obj_root
    | S of obj_root
  [@@deriving bin_io]
end
open Dir_entry
</span><span class="comment-delimiter">*)</span>

<span class="governing">type</span> <span class="type">dir_entry</span> <span class="operator">=</span> <span class="module">S1.</span>dir_entry
<span class="tuareg-font-double-colon-face">;;</span>


<span class="doc">(** {2 Various marshallers} *)</span>

<span class="governing">module</span> <span class="module">Ms</span> <span class="operator">=</span> <span class="governing">struct</span>
  <span class="governing">open </span><span class="module">Tjr_btree.Make_3</span>

<span class="comment-delimiter">(*</span><span class="comment">
  let id_mshlr : id bin_mshlr = 
    (module 
      (struct 
        type t = id[@@deriving bin_io] 
        let max_sz = 10 (* FIXME check 9+1 *)
      end))
</span><span class="comment-delimiter">*)</span>

  <span class="governing">let</span> <span class="variable-name">int_mshlr</span> <span class="operator">:</span> <span class="type">int bin_mshlr </span><span class="operator">=</span> 
    <span class="operator">(</span><span class="governing">module</span> 
      <span class="operator">(</span><span class="governing">struct</span> 
        <span class="governing">type</span> <span class="type">t</span> <span class="operator">=</span> int<span class="attribute">[@@deriving bin_io]</span> 
        <span class="governing">let</span> <span class="variable-name">max_sz</span> <span class="operator">=</span> 10 <span class="comment-delimiter">(* </span><span class="comment">FIXME check 9+1 </span><span class="comment-delimiter">*)</span>
      <span class="governing">end</span><span class="operator">))</span>

  <span class="governing">let</span> <span class="variable-name">blk_id_mshlr</span> <span class="operator">:</span> <span class="type">blk_id bin_mshlr </span><span class="operator">=</span> 
    <span class="operator">(</span><span class="governing">module</span> 
      <span class="operator">(</span><span class="governing">struct</span> 
        <span class="governing">type</span> <span class="type">t</span> <span class="operator">=</span> blk_id<span class="attribute">[@@deriving bin_io]</span> 
        <span class="governing">let</span> <span class="variable-name">max_sz</span> <span class="operator">=</span> 10 <span class="comment-delimiter">(* </span><span class="comment">FIXME check 9+1 </span><span class="comment-delimiter">*)</span>
      <span class="governing">end</span><span class="operator">))</span>

  <span class="governing">let</span> <span class="variable-name">dir_entry_mshlr</span> <span class="operator">:</span> <span class="type">dir_entry bin_mshlr </span><span class="operator">=</span> 
    <span class="operator">(</span><span class="governing">module</span> 
      <span class="operator">(</span><span class="governing">struct</span> 
        <span class="governing">type</span> <span class="type">t</span> <span class="operator">=</span> dir_entry<span class="attribute">[@@deriving bin_io]</span> 
        <span class="governing">let</span> <span class="variable-name">max_sz</span> <span class="operator">=</span> 10 <span class="comment-delimiter">(* </span><span class="comment">FIXME check 9+1 </span><span class="comment-delimiter">*)</span>
      <span class="governing">end</span><span class="operator">))</span>

  <span class="governing">open </span><span class="module">Str_256</span>
  <span class="governing">let</span> <span class="variable-name">s256_mshlr</span> <span class="operator">:</span> <span class="type">str_256 bin_mshlr </span><span class="operator">=</span>
    <span class="operator">(</span><span class="governing">module</span> 
      <span class="operator">(</span><span class="governing">struct</span> 
        <span class="governing">type</span> <span class="type">t</span> <span class="operator">=</span> str_256<span class="attribute">[@@deriving bin_io]</span> 
        <span class="governing">let</span> <span class="variable-name">max_sz</span> <span class="operator">=</span> 259 <span class="comment-delimiter">(* </span><span class="comment">FIXME check 256+3 </span><span class="comment-delimiter">*)</span>
      <span class="governing">end</span><span class="operator">))</span>
<span class="governing">end</span>



<span class="doc">(** {2 Various runtime components that get filled in later} *)</span>

<span class="governing">let</span> <span class="variable-name">blk_dev_ref</span> <span class="operator">=</span> <span class="builtin">ref</span> <span class="constructor">None</span>
<span class="governing">let</span> <span class="variable-name">blk_dev_ops</span> <span class="operator">:</span> <span class="operator">(</span><span class="type">_</span><span class="operator">,</span><span class="type">_</span><span class="operator">,</span><span class="type">_</span><span class="operator">)</span><span class="type"> blk_dev_ops </span><span class="module">Lazy.</span><span class="type">t </span><span class="operator">=</span> <span class="keyword">lazy</span> <span class="operator">(</span>
  <span class="keyword">match</span> <span class="operator">!</span>blk_dev_ref <span class="keyword">with</span>
  <span class="operator">|</span> <span class="constructor">None</span> <span class="operator">-&gt;</span> <span class="builtin">failwith</span> <span class="constant">__LOC__</span>
  <span class="operator">|</span> <span class="constructor">Some</span> x <span class="operator">-&gt;</span> x<span class="operator">)</span>


<span class="governing">let</span> <span class="variable-name">blk_alloc_ref</span> <span class="operator">=</span> <span class="builtin">ref</span> <span class="constructor">None</span>  
<span class="governing">let</span> <span class="variable-name">blk_alloc</span> <span class="operator">:</span> <span class="operator">(</span><span class="type">_</span><span class="operator">,</span><span class="type">_</span><span class="operator">)</span><span class="type">blk_allocator_ops </span><span class="module">Lazy.</span><span class="type">t </span><span class="operator">=</span> <span class="keyword">lazy</span> <span class="operator">(</span>
  <span class="keyword">match</span> <span class="operator">!</span>blk_alloc_ref <span class="keyword">with</span> 
  <span class="operator">|</span> <span class="constructor">None</span> <span class="operator">-&gt;</span> <span class="builtin">failwith</span> <span class="constant">__LOC__</span>
  <span class="operator">|</span> <span class="constructor">Some</span> x <span class="operator">-&gt;</span> x<span class="operator">)</span>


<span class="governing">let</span> <span class="variable-name">root_ops_ref</span> <span class="operator">=</span> <span class="builtin">ref</span> <span class="constructor">None</span>
<span class="governing">let</span> <span class="variable-name">root_ops</span> <span class="operator">:</span> <span class="operator">(</span><span class="type">_</span><span class="operator">,</span><span class="type">_</span><span class="operator">)</span><span class="type">with_state </span><span class="module">Lazy.</span><span class="type">t </span><span class="operator">=</span> <span class="keyword">lazy</span> <span class="operator">(</span>
  <span class="keyword">match</span> <span class="operator">!</span>root_ops_ref <span class="keyword">with</span>
  <span class="operator">|</span> <span class="constructor">None</span> <span class="operator">-&gt;</span> <span class="builtin">failwith</span> <span class="constant">__LOC__</span>
  <span class="operator">|</span> <span class="constructor">Some</span> x <span class="operator">-&gt;</span> x<span class="operator">)</span>


<span class="doc">(** We use mutually exclusive subsets of int for identifiers *)</span>
<span class="governing">let</span> <span class="variable-name">min_free_id_ref</span> <span class="operator">=</span> <span class="builtin">ref</span> 0
<span class="governing">let</span> <span class="function-name">new_id</span><span class="variable-name"> </span><span class="operator">()</span> <span class="operator">=</span> 
  <span class="governing">let</span> <span class="variable-name">r</span> <span class="operator">=</span> <span class="operator">!</span>min_free_id_ref <span class="governing">in</span>
  incr min_free_id_ref<span class="operator">;</span>
  return r

<span class="governing">let</span> <span class="function-name">new_did</span><span class="variable-name"> </span><span class="operator">()</span> <span class="operator">=</span> new_id <span class="operator">()</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">did</span> <span class="operator">-&gt;</span> return <span class="operator">{</span>did<span class="operator">}</span>

<span class="governing">let</span> <span class="function-name">new_fid</span><span class="variable-name"> </span><span class="operator">()</span> <span class="operator">=</span> new_id <span class="operator">()</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">fid</span> <span class="operator">-&gt;</span> return <span class="operator">{</span>fid<span class="operator">}</span>

<span class="governing">let</span> <span class="function-name">new_sid</span><span class="variable-name"> </span><span class="operator">()</span> <span class="operator">=</span> new_id <span class="operator">()</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">sid</span> <span class="operator">-&gt;</span> return <span class="operator">{</span>sid<span class="operator">}</span>


<span class="doc">(** {2 The global object map (GOM) } *)</span>


<span class="governing">module</span> <span class="module">Gom</span> <span class="operator">=</span> <span class="governing">struct</span>
  <span class="governing">open </span><span class="module">Tjr_btree.Make_3</span>
  <span class="governing">open </span><span class="module">Ms</span>

  <span class="doc">(** Could just use disjoint subsets of int and drop the constructors *)</span>

  <span class="governing">type</span> <span class="type">id</span> <span class="operator">=</span> dir_entry
  <span class="attribute">[@@deriving bin_io]</span>

  <span class="governing">let</span> <span class="variable-name">id_mshlr</span> <span class="operator">:</span> <span class="type">id bin_mshlr </span><span class="operator">=</span> 
    <span class="operator">(</span><span class="governing">module</span> 
      <span class="operator">(</span><span class="governing">struct</span> 
        <span class="governing">type</span> <span class="type">t</span> <span class="operator">=</span> id<span class="attribute">[@@deriving bin_io]</span> 
        <span class="governing">let</span> <span class="variable-name">max_sz</span> <span class="operator">=</span> 10 <span class="comment-delimiter">(* </span><span class="comment">FIXME check 9+1 </span><span class="comment-delimiter">*)</span>
      <span class="governing">end</span><span class="operator">))</span>
  
  <span class="governing">let</span> <span class="function-name">consistent_entry</span><span class="variable-name"> id e</span> <span class="operator">=</span> 
    <span class="keyword">match</span> id<span class="operator">,</span>e <span class="keyword">with</span>
    <span class="operator">|</span> <span class="constructor">F</span><span class="constructor">id</span> _<span class="operator">,</span><span class="constructor">Fid</span> _  <span class="operator">|</span> <span class="constructor">Did</span> _<span class="operator">,</span><span class="constructor">Did</span> _ <span class="operator">|</span> <span class="constructor">Sid</span> _<span class="operator">,</span> <span class="constructor">Sid</span> _ <span class="operator">-&gt;</span> <span class="constant">true</span>
    <span class="operator">|</span> _ <span class="operator">-&gt;</span> <span class="constant">false</span>

  <span class="governing">type</span> <span class="type">k</span> <span class="operator">=</span> id<span class="attribute">[@@deriving bin_io]</span>

  <span class="governing">let</span> <span class="variable-name">k_mshlr</span> <span class="operator">:</span> <span class="type">k bin_mshlr </span><span class="operator">=</span> id_mshlr

  <span class="doc">(** The gom maps an id to a root blk *)</span>
  <span class="governing">type</span> <span class="type">v</span> <span class="operator">=</span> blk_id

  <span class="governing">let</span> <span class="variable-name">v_mshlr</span> <span class="operator">:</span> <span class="type">v bin_mshlr </span><span class="operator">=</span> blk_id_mshlr

  <span class="governing">let</span> <span class="variable-name">gom_args</span> <span class="operator">=</span> <span class="governing">object</span>
    <span class="governing">method</span> <span class="function-name">k_cmp</span><span class="operator">:</span> id <span class="operator">-&gt;</span> id <span class="operator">-&gt;</span> int <span class="operator">=</span> <span class="module">Stdlib.</span>compare
    <span class="governing">method</span> <span class="function-name">k_mshlr</span> <span class="operator">=</span> k_mshlr
    <span class="governing">method</span> <span class="function-name">v_mshlr</span> <span class="operator">=</span> v_mshlr
  <span class="governing">end</span>  
<span class="governing">end</span>
<span class="comment-delimiter">(* </span><span class="comment">open Gom </span><span class="comment-delimiter">*)</span>

<span class="governing">let</span> <span class="variable-name">gom_btree</span> <span class="operator">:</span> <span class="operator">(</span><span class="module">Gom.</span><span class="type">k</span><span class="operator">,</span><span class="module">Gom.</span><span class="type">v</span><span class="operator">,</span><span class="type">t</span><span class="operator">)</span><span class="type"> uncached_btree </span><span class="module">Lazy.</span><span class="type">t </span><span class="operator">=</span> <span class="keyword">lazy</span> <span class="operator">(</span>
  <span class="module">Tjr_btree.Make_4.</span>make
    <span class="label">~args</span><span class="operator">:</span><span class="module">Gom.</span>gom_args
    <span class="label">~blk_dev_ops</span><span class="operator">:(</span><span class="module">Lazy.</span>force blk_dev_ops<span class="operator">)</span>
    <span class="label">~blk_alloc</span><span class="operator">:(</span><span class="module">Lazy.</span>force blk_alloc<span class="operator">)</span>
    <span class="label">~root_ops</span><span class="operator">:(</span><span class="module">Lazy.</span>force root_ops<span class="operator">))</span>

<span class="governing">let</span> <span class="variable-name">_</span> <span class="operator">=</span> gom_btree



<span class="doc">(** {2 Definitions after the GOM has been initialized} *)</span>

<span class="doc">(** NOTE Instantiate this after gom_btree has been initialized *)</span>
<span class="governing">module</span> <span class="module">With_gom</span><span class="operator">()</span> <span class="operator">=</span> <span class="governing">struct</span>
  <span class="governing">let</span> <span class="variable-name">blk_dev_ops</span> <span class="operator">=</span> <span class="module">Lazy.</span>force blk_dev_ops 
  <span class="governing">let</span> <span class="variable-name">blk_alloc</span> <span class="operator">=</span> <span class="module">Lazy.</span>force blk_alloc
  <span class="governing">let</span> <span class="variable-name">gom_btree</span> <span class="operator">=</span> <span class="module">Lazy.</span>force gom_btree 

  <span class="governing">let</span> <span class="variable-name">gom_find_opt</span> <span class="operator">=</span> gom_btree<span class="operator">#</span>find

  <span class="governing">let</span> <span class="function-name">gom_find</span><span class="variable-name"> k</span> <span class="operator">=</span> gom_find_opt k <span class="operator">&gt;&gt;=</span> <span class="keyword">function</span>
    <span class="operator">|</span> <span class="constructor">Some</span> r <span class="operator">-&gt;</span> return r
    <span class="operator">|</span> <span class="constructor">None</span> <span class="operator">-&gt;</span> <span class="builtin">failwith</span> <span class="string">&quot;gom: id did not map to an entry&quot;</span>
    
  <span class="governing">let</span> <span class="variable-name">gom_insert</span> <span class="operator">=</span> gom_btree<span class="operator">#</span>insert

  <span class="governing">let</span> <span class="variable-name">gom_delete</span> <span class="operator">=</span> gom_btree<span class="operator">#</span>delete


  <span class="doc">(** In order to incorporate </span><span class="doc">path resolution, we need to be able to</span><span class="doc">
</span><span class="doc">     lo</span><span class="doc">okup an entry in a directory *)</span>

  <span class="governing">module</span> <span class="module">Make_root_blk_ops</span><span class="operator">(</span><span class="constructor">S</span><span class="operator">:</span><span class="governing">sig</span> <span class="governing">type</span> <span class="type">rb</span><span class="attribute">[@@deriving bin_io]</span> <span class="governing">end</span><span class="operator">)</span> <span class="operator">=</span> <span class="governing">struct</span>
    <span class="governing">include</span> <span class="module">S</span>
    <span class="governing">let</span> <span class="function-name">write_rb</span><span class="variable-name"> </span><span class="operator">~</span><span class="variable-name">blk_id rb</span> <span class="operator">=</span>
      <span class="comment-delimiter">(* </span><span class="comment">FIXME have a single buf_create, specialized to std_type and buf_sz </span><span class="comment-delimiter">*)</span>
      <span class="governing">let</span> <span class="variable-name">buf</span> <span class="operator">=</span> buf_create <span class="operator">()</span> <span class="governing">in</span>
      bin_write_rb buf <span class="label">~pos</span><span class="operator">:</span>0 rb <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">_</span> <span class="operator">-&gt;</span>
      blk_dev_ops.write <span class="operator">~</span>blk_id <span class="label">~blk</span><span class="operator">:</span>buf
    <span class="governing">let</span> <span class="function-name">read_rb</span><span class="operator">:</span> <span class="label">blk_id</span><span class="operator">:</span><span class="type">blk_id </span><span class="operator">-&gt;</span><span class="type"> </span><span class="operator">(</span><span class="type">rb</span><span class="operator">,</span><span class="type">t</span><span class="operator">)</span><span class="type">m </span><span class="operator">=</span> <span class="keyword">fun</span> <span class="operator">~</span><span class="variable-name">blk_id</span> <span class="operator">-&gt;</span>
      blk_dev_ops.read <span class="operator">~</span>blk_id <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">blk</span> <span class="operator">-&gt;</span>
      bin_read_rb blk <span class="label">~pos_ref</span><span class="operator">:(</span><span class="builtin">ref</span> 0<span class="operator">)</span> <span class="operator">|&gt;</span> <span class="keyword">fun</span> <span class="variable-name">rb</span> <span class="operator">-&gt;</span>
      return rb
  <span class="governing">end</span>


  <span class="comment-delimiter">(</span><span class="comment-delimiter">* </span><span class="comment">FIXME we could perhaps split dir_ops into the</span><span class="comment"> </span><span class="comment">find/insert/delete
     operations on the map, and the other</span><span class="comment"> </span><span class="comment">operations that work with
     the root block </span><span class="comment-delimiter">*)</span>

  <span class="governing">module</span> <span class="module">Dir</span> <span class="operator">=</span> <span class="governing">struct</span>
    <span class="governing">open </span><span class="module">Ms</span>
    <span class="governing">open </span><span class="module">Tjr_btree.Make_3</span>
    <span class="governing">open </span><span class="module">Str_256</span>

    <span class="governing">module</span> <span class="module">Rb</span> <span class="operator">=</span> <span class="governing">struct</span> <span class="governing">type</span> <span class="type">rb</span> <span class="operator">=</span> <span class="operator">{</span> map_root<span class="operator">:</span>blk_id<span class="operator">;</span> parent<span class="operator">:</span>did<span class="operator">;</span> times<span class="operator">:</span>stat_times <span class="operator">}</span><span class="attribute">[@@deriving bin_io]</span> <span class="governing">end</span>    
    <span class="governing">include</span> <span class="module">Make_root_blk_ops</span><span class="operator">(</span><span class="module">Rb</span><span class="operator">)</span>

    <span class="governing">type</span> <span class="type">k</span> <span class="operator">=</span> str_256
    <span class="governing">type</span> <span class="type">v</span> <span class="operator">=</span> <span class="module">Gom.</span>id

    <span class="governing">let</span> <span class="variable-name">k_mshlr</span> <span class="operator">=</span> s256_mshlr
    <span class="governing">let</span> <span class="variable-name">v_mshlr</span> <span class="operator">=</span> <span class="module">Gom.</span>id_mshlr

    <span class="governing">let</span> <span class="variable-name">dir_args</span> <span class="operator">=</span> <span class="governing">object</span>
      <span class="governing">method</span> <span class="function-name">k_cmp</span><span class="operator">:</span> str_256 <span class="operator">-&gt;</span> str_256 <span class="operator">-&gt;</span> int <span class="operator">=</span> <span class="module">Stdlib.</span>compare
      <span class="governing">method</span> <span class="function-name">k_mshlr</span> <span class="operator">=</span> k_mshlr
      <span class="governing">method</span> <span class="function-name">v_mshlr</span> <span class="operator">=</span> v_mshlr
    <span class="governing">end</span>

    <span class="governing">let</span> <span class="function-name">dir_map_ops</span><span class="variable-name"> </span><span class="operator">~</span><span class="variable-name">root_ops</span> <span class="operator">=</span> 
      <span class="module">Tjr_btree.Make_4.</span>make 
        <span class="label">~args</span><span class="operator">:</span>dir_args
        <span class="operator">~</span>blk_dev_ops
        <span class="operator">~</span>blk_alloc
        <span class="operator">~</span>root_ops

    <span class="governing">let</span> <span class="variable-name">_</span> <span class="operator">:</span> <span class="label">root_ops</span><span class="operator">:</span><span class="type">_ </span><span class="operator">-&gt;</span><span class="type"> </span><span class="operator">(</span><span class="type">k</span><span class="operator">,</span><span class="type">v</span><span class="operator">,</span><span class="type">t</span><span class="operator">)</span><span class="type"> uncached_btree </span><span class="operator">=</span> dir_map_ops

    <span class="governing">let</span> <span class="variable-name">_</span> <span class="operator">=</span> gom_find

    <span class="governing">let</span> <span class="variable-name">read_symlink</span><span class="operator">:</span> <span class="operator">(</span><span class="type">sid </span><span class="operator">-&gt;</span><span class="type"> </span><span class="operator">(</span><span class="type">str_256</span><span class="operator">,</span><span class="type">t</span><span class="operator">)</span><span class="type">m</span><span class="operator">)</span><span class="type"> </span><span class="builtin">ref</span><span class="type"> </span><span class="operator">=</span> <span class="builtin">ref</span> <span class="operator">(</span><span class="keyword">fun</span> <span class="variable-name">_sid</span> <span class="operator">-&gt;</span> 
      <span class="builtin">failwith</span> <span class="string">&quot;impossible: this is patched later&quot;</span><span class="operator">)</span>

    <span class="governing">open </span><span class="module">Tjr_path_resolution.Intf</span>
    <span class="governing">let</span> <span class="variable-name">resolve_comp</span><span class="operator">:</span> <span class="type">did </span><span class="operator">-&gt;</span><span class="type"> comp_ </span><span class="operator">-&gt;</span><span class="type"> </span><span class="operator">((</span><span class="type">fid</span><span class="operator">,</span><span class="type">did</span><span class="operator">)</span><span class="type">resolved_comp</span><span class="operator">,</span><span class="type">t</span><span class="operator">)</span><span class="type">m </span><span class="operator">=</span> 
      <span class="keyword">fun</span> <span class="variable-name">d</span><span class="variable-name">id comp</span> <span class="operator">-&gt;</span>
      <span class="keyword">assert</span><span class="operator">(</span><span class="module">String.</span>length comp <span class="operator">&lt;=</span> 256<span class="operator">);</span>
      <span class="governing">let</span> <span class="variable-name">comp</span> <span class="operator">=</span> <span class="module">Str_256.</span>make comp <span class="governing">in</span>
      gom_find <span class="operator">(</span><span class="constructor">Did</span> did<span class="operator">)</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">r</span><span class="operator">:</span><span class="type">blk_id</span><span class="operator">)</span> <span class="operator">-&gt;</span> 
      <span class="governing">let</span> <span class="variable-name">r</span> <span class="operator">=</span> <span class="builtin">ref</span> r <span class="governing">in</span>
      <span class="governing">let</span> <span class="variable-name">root_ops</span> <span class="operator">=</span> with_ref r <span class="governing">in</span>
      <span class="governing">let</span> <span class="variable-name">dir_map_ops</span> <span class="operator">=</span> dir_map_ops <span class="operator">~</span>root_ops <span class="governing">in</span>
      dir_map_ops<span class="operator">#</span>find comp <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">vopt</span> <span class="operator">-&gt;</span>
      <span class="keyword">match</span> vopt <span class="keyword">with</span>
      <span class="operator">|</span> <span class="constructor">None</span> <span class="operator">-&gt;</span> return <span class="constructor">RC_missing</span>
      <span class="operator">|</span> <span class="constructor">Some</span> x <span class="operator">-&gt;</span> 
        <span class="keyword">match</span> x <span class="keyword">with</span>
        <span class="operator">|</span> <span class="constructor">F</span><span class="constructor">id</span> fid <span class="operator">-&gt;</span> <span class="constructor">RC_file</span> fid <span class="operator">|&gt;</span> return
        <span class="operator">|</span> <span class="constructor">Did</span> did <span class="operator">-&gt;</span> <span class="constructor">RC_dir</span> did <span class="operator">|&gt;</span> return
        <span class="operator">|</span> <span class="constructor">S</span><span class="constructor">id</span> sid <span class="operator">-&gt;</span> 
          <span class="operator">(!</span>read_symlink<span class="operator">)</span> sid <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">s</span> <span class="operator">-&gt;</span>
          <span class="constructor">RC_sym</span> <span class="operator">(</span>s256_to_string s<span class="operator">)</span> <span class="operator">|&gt;</span> return
          <span class="comment-delimiter">(* </span><span class="comment">FIXME perhaps we also need to identify a symlink by id
             during path res? </span><span class="comment-delimiter">*)</span>

    <span class="governing">let</span> <span class="variable-name">fs_ops</span> <span class="operator">=</span> <span class="operator">{</span>
      root<span class="operator">=</span>root_did<span class="operator">;</span>
      resolve_comp
    <span class="operator">}</span>

    <span class="comment-delimiter">(* </span><span class="comment">NOTE for fuse we always resolve absolute paths </span><span class="comment-delimiter">*)</span>
    <span class="governing">let</span> <span class="variable-name">resolve</span> <span class="operator">=</span> <span class="module">Tjr_path_resolution.</span>resolve <span class="operator">~</span>monad_ops <span class="operator">~</span>fs_ops <span class="label">~cwd</span><span class="operator">:</span>root_did

    <span class="governing">let</span> <span class="variable-name">_</span> <span class="operator">:</span><span class="type">
      </span><span class="label">follow_last_symlink</span><span class="operator">:</span><span class="type">follow_last_symlink </span><span class="operator">-&gt;</span><span class="type">
      string </span><span class="operator">-&gt;</span><span class="type">
      </span><span class="operator">((</span><span class="type">fid</span><span class="operator">,</span><span class="type"> did</span><span class="operator">)</span><span class="type"> resolved_path_or_err</span><span class="operator">,</span><span class="type">t</span><span class="operator">)</span><span class="type">m 
      </span><span class="operator">=</span> resolve

    <span class="governing">let</span> <span class="function-name">write_empty_leaf</span><span class="variable-name"> </span><span class="operator">~</span><span class="variable-name">blk_id</span> <span class="operator">=</span>
      blk_dev_ops.write <span class="operator">~</span>blk_id <span class="label">~blk</span><span class="operator">:(</span><span class="builtin">failwith</span> <span class="string">&quot;FIXME&quot;</span><span class="operator">)</span> 

  <span class="governing">end</span>
  <span class="governing">let</span> <span class="variable-name">resolve_path</span> <span class="operator">=</span> <span class="module">Dir.</span>resolve

  <span class="doc">(** The dirs ops, find and delete FIXME these need to be maintained
     in a pool, and only one instance per id *)</span>
  <span class="governing">let</span> <span class="variable-name">dirs</span> <span class="operator">:</span> <span class="type">dirs_ops </span><span class="operator">=</span> <span class="operator">{</span>
    find <span class="operator">=</span> <span class="operator">(</span><span class="keyword">fun</span> <span class="variable-name">did</span> <span class="operator">-&gt;</span> 
        gom_find <span class="operator">(</span><span class="constructor">Did</span> did<span class="operator">)</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">blk_id</span> <span class="operator">-&gt;</span>
        <span class="module">Dir.</span>read_rb <span class="operator">~</span>blk_id <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">rb</span> <span class="operator">-&gt;</span>
        <span class="governing">let</span> <span class="variable-name">rb</span> <span class="operator">=</span> <span class="builtin">ref</span> rb <span class="governing">in</span>
        <span class="governing">let</span> <span class="function-name">write_rb</span><span class="variable-name"> </span><span class="operator">()</span> <span class="operator">=</span> <span class="module">Dir.</span>write_rb <span class="operator">~</span>blk_id <span class="operator">(!</span>rb<span class="operator">)</span> <span class="governing">in</span>
        <span class="governing">let</span> <span class="variable-name">root_ops</span> <span class="operator">=</span> 
          <span class="governing">let</span> <span class="function-name">with_state</span><span class="variable-name"> f</span> <span class="operator">=</span> 
            f <span class="label">~state</span><span class="operator">:(!</span>rb.map_root<span class="operator">)</span> <span class="label">~set_state</span><span class="operator">:(</span><span class="keyword">fun</span> <span class="variable-name">map_root</span> <span class="operator">-&gt;</span>
                rb<span class="operator">:={!</span>rb <span class="keyword">with</span> map_root<span class="operator">};</span>
                write_rb<span class="operator">())</span>
          <span class="governing">in</span>
          <span class="operator">{</span>with_state<span class="operator">}</span>
        <span class="governing">in</span>
        <span class="governing">let</span> <span class="variable-name">dir_map_ops</span> <span class="operator">=</span> <span class="module">Dir.</span>dir_map_ops <span class="operator">~</span>root_ops <span class="governing">in</span>
        <span class="governing">let</span> <span class="function-name">set_parent</span><span class="variable-name"> did</span> <span class="operator">=</span> 
          rb<span class="operator">:={!</span>rb <span class="keyword">with</span> parent<span class="operator">=</span>did<span class="operator">};</span>
          write_rb<span class="operator">()</span>
        <span class="governing">in</span>
        <span class="governing">let</span> <span class="function-name">get_parent</span><span class="variable-name"> </span><span class="operator">()</span> <span class="operator">=</span> <span class="operator">(!</span>rb<span class="operator">)</span>.parent <span class="operator">|&gt;</span> return <span class="governing">in</span>
        <span class="governing">let</span> <span class="function-name">set_times</span><span class="variable-name"> times</span> <span class="operator">=</span>
          rb<span class="operator">:={!</span>rb <span class="keyword">with</span> times<span class="operator">};</span>
          write_rb<span class="operator">()</span>
        <span class="governing">in</span>
        <span class="governing">let</span> <span class="function-name">get_times</span><span class="variable-name"> </span><span class="operator">()</span> <span class="operator">=</span> <span class="operator">(!</span>rb<span class="operator">)</span>.times <span class="operator">|&gt;</span> return <span class="governing">in</span>          
        <span class="governing">let</span> <span class="variable-name">dir_ops</span> <span class="operator">=</span> <span class="operator">{</span>
          find<span class="operator">=</span>dir_map_ops<span class="operator">#</span>find<span class="operator">;</span>
          insert<span class="operator">=</span>dir_map_ops<span class="operator">#</span>insert<span class="operator">;</span>
          delete<span class="operator">=</span>dir_map_ops<span class="operator">#</span>delete<span class="operator">;</span>
          ls_create<span class="operator">=</span>dir_map_ops<span class="operator">#</span>ls_create<span class="operator">;</span>
          set_parent<span class="operator">;</span>
          get_parent<span class="operator">;</span>
          set_times<span class="operator">;</span>
          get_times<span class="operator">;</span>
        <span class="operator">}</span>
        <span class="governing">in</span>
        return dir_ops<span class="operator">);</span>                           
    delete <span class="operator">=</span> <span class="operator">(</span><span class="keyword">fun</span> <span class="variable-name">did</span> <span class="operator">-&gt;</span> gom_delete <span class="operator">(</span><span class="constructor">Did</span> did<span class="operator">))</span>
  <span class="operator">}</span>


  <span class="governing">module</span> <span class="module">File</span> <span class="operator">=</span> <span class="governing">struct</span>

    <span class="comment-delimiter">(* </span><span class="comment">FIXME we really want sz to be stored in the btree, not in the
       underlying file </span><span class="comment-delimiter">*)</span>
    <span class="comment-delimiter">(* </span><span class="comment">FIXME of course, there should be a pool, and fds should be
       closed when files expunged from pool </span><span class="comment-delimiter">*)</span>
    <span class="governing">module</span> <span class="module">Rb</span> <span class="operator">=</span> <span class="governing">struct</span>
      <span class="governing">type</span> <span class="type">rb</span> <span class="operator">=</span> <span class="operator">{</span> times<span class="operator">:</span> stat_times <span class="operator">}</span><span class="attribute">[@@deriving bin_io]</span>
    <span class="governing">end</span>
    <span class="governing">include</span> <span class="module">Make_root_blk_ops</span><span class="operator">(</span><span class="module">Rb</span><span class="operator">)</span>

    <span class="governing">let</span> <span class="function-name">fn</span><span class="variable-name"> fid</span> <span class="operator">=</span> <span class="module">Printf.</span>sprintf <span class="string">&quot;/tmp/%d&quot;</span> fid.fid

    <span class="governing">let</span> <span class="function-name">get_fd</span> <span class="operator">:</span> <span class="label">fid</span><span class="operator">:</span><span class="type">fid </span><span class="operator">-&gt;</span><span class="type"> </span><span class="label">foff</span><span class="operator">:</span><span class="type">int </span><span class="operator">-&gt;</span><span class="type"> </span><span class="operator">(</span><span class="module">Lwt_unix.</span><span class="type">file_descr</span><span class="operator">,</span><span class="type">t</span><span class="operator">)</span><span class="type">m </span><span class="operator">=</span> <span class="keyword">fun</span> <span class="operator">~</span><span class="variable-name">fid </span><span class="operator">~</span><span class="variable-name">foff</span> <span class="operator">-&gt;</span>
      <span class="governing">let</span> <span class="variable-name">default_file_perm</span> <span class="operator">=</span> <span class="module">Tjr_file.</span>default_create_perm <span class="governing">in</span>
      <span class="operator">(</span>from_lwt <span class="module">Lwt_unix.</span><span class="operator">(</span>openfile <span class="operator">(</span>fn fid<span class="operator">)</span> <span class="operator">[</span><span class="constructor">O_RDONLY</span><span class="operator">]</span> default_file_perm<span class="operator">))</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">fd</span> <span class="operator">-&gt;</span>
      <span class="operator">(</span>from_lwt <span class="module">Lwt_unix.</span><span class="operator">(</span>lseek fd foff <span class="constructor">SEEK_SET</span><span class="operator">))</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">_</span><span class="operator">:</span><span class="type">int</span><span class="operator">)</span> <span class="operator">-&gt;</span>
      return fd

    <span class="governing">let</span> <span class="function-name">close</span><span class="variable-name"> fd</span> <span class="operator">=</span> <span class="operator">(</span>from_lwt <span class="module">Lwt_unix.</span><span class="operator">(</span>close fd<span class="operator">)</span><span class="operator">)</span>

    <span class="governing">let</span> <span class="function-name">pread</span><span class="variable-name"> </span><span class="operator">~</span><span class="variable-name">fid </span><span class="operator">~</span><span class="variable-name">foff </span><span class="operator">~</span><span class="variable-name">len </span><span class="operator">~</span><span class="variable-name">buf </span><span class="operator">~</span><span class="variable-name">boff</span> <span class="operator">=</span> 
      get_fd <span class="operator">~</span>fid <span class="operator">~</span>foff <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">fd</span> <span class="operator">-&gt;</span>
      <span class="governing">let</span> <span class="variable-name">bs</span> <span class="operator">=</span> <span class="module">Bytes.</span>create <span class="operator">(</span>buf_ops.len buf <span class="operator">-</span> boff<span class="operator">)</span> <span class="governing">in</span>
      <span class="operator">(</span>from_lwt <span class="module">Lwt_unix.</span><span class="operator">(</span>read fd bs boff len<span class="operator">))</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="operator">(</span><span class="variable-name">n</span><span class="operator">:</span><span class="type">int</span><span class="operator">)</span> <span class="operator">-&gt;</span>
      <span class="module">Bigstring.</span>blit_of_bytes bs 0 buf boff n<span class="operator">;</span>
      close fd <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="operator">()</span> <span class="operator">-&gt;</span>
      return <span class="operator">(</span><span class="constructor">Ok</span> n<span class="operator">)</span>

    <span class="governing">let</span> <span class="function-name">pwrite</span><span class="variable-name"> </span><span class="operator">~</span><span class="variable-name">fid </span><span class="operator">~</span><span class="variable-name">foff </span><span class="operator">~</span><span class="variable-name">len </span><span class="operator">~</span><span class="variable-name">buf </span><span class="operator">~</span><span class="variable-name">boff</span> <span class="operator">=</span> 
      get_fd <span class="operator">~</span>fid <span class="operator">~</span>foff <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">fd</span> <span class="operator">-&gt;</span>
      <span class="governing">let</span> <span class="variable-name">bs</span> <span class="operator">=</span> <span class="module">Bigstring.</span>to_bytes buf <span class="governing">in</span>  <span class="comment-delimiter">(* </span><span class="comment">FIXME don't need whole buf </span><span class="comment-delimiter">*)</span>
      <span class="operator">(</span>from_lwt <span class="module">Lwt_unix.</span><span class="operator">(</span>write fd bs boff len<span class="operator">))</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">n</span> <span class="operator">-&gt;</span>
      <span class="keyword">assert</span><span class="operator">(</span>n<span class="operator">=</span>len<span class="operator">);</span> <span class="comment-delimiter">(* </span><span class="comment">FIXME </span><span class="comment-delimiter">*)</span>
      <span class="module">Bigstring.</span>blit_of_bytes bs boff buf boff n<span class="operator">;</span>
      close fd <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="operator">()</span> <span class="operator">-&gt;</span>
      return <span class="operator">(</span><span class="constructor">Ok</span> n<span class="operator">)</span>

    <span class="governing">let</span> <span class="function-name">truncate</span><span class="variable-name"> </span><span class="operator">~</span><span class="variable-name">fid len</span> <span class="operator">=</span> 
      <span class="operator">(</span>from_lwt <span class="module">Lwt_unix.</span><span class="operator">(</span>truncate <span class="operator">(</span>fn fid<span class="operator">)</span> len<span class="operator">))</span>
      
    <span class="governing">let</span> <span class="function-name">get_sz</span><span class="variable-name"> </span><span class="operator">~</span><span class="variable-name">fid </span><span class="operator">()</span> <span class="operator">=</span>
      <span class="operator">(</span>from_lwt <span class="module">Lwt_unix.</span><span class="operator">(</span>stat <span class="operator">(</span>fn fid<span class="operator">)))</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">st</span> <span class="operator">-&gt;</span> 
      return st.st_size

    <span class="governing">let</span> <span class="function-name">file_ops</span><span class="variable-name"> </span><span class="operator">~</span><span class="variable-name">fid</span> <span class="operator">=</span> 
      gom_find <span class="operator">(</span><span class="constructor">Fid</span> fid<span class="operator">)</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">blk_id</span> <span class="operator">-&gt;</span>
      read_rb <span class="operator">~</span>blk_id <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">rb</span> <span class="operator">-&gt;</span>
      <span class="governing">let</span> <span class="variable-name">rb</span> <span class="operator">=</span> <span class="builtin">ref</span> rb <span class="governing">in</span>
      <span class="governing">let</span> <span class="function-name">set_times</span><span class="variable-name"> times</span> <span class="operator">=</span> 
        rb<span class="operator">:={</span>times<span class="operator">};</span>
        write_rb <span class="operator">~</span>blk_id <span class="operator">!</span>rb
      <span class="governing">in</span>
      <span class="governing">let</span> <span class="function-name">get_times</span><span class="variable-name"> </span><span class="operator">()</span> <span class="operator">=</span>
        <span class="operator">(!</span>rb<span class="operator">)</span>.times <span class="operator">|&gt;</span> return
      <span class="governing">in</span>
      return <span class="operator">{</span> pread<span class="operator">=</span>pread <span class="operator">~</span>fid<span class="operator">;</span>
               pwrite<span class="operator">=</span>pwrite <span class="operator">~</span>fid<span class="operator">;</span>
               truncate<span class="operator">=</span>truncate <span class="operator">~</span>fid<span class="operator">;</span>
               get_sz<span class="operator">=</span>get_sz <span class="operator">~</span>fid<span class="operator">;</span>
               set_times<span class="operator">;</span>
               get_times
             <span class="operator">}</span>          
  <span class="governing">end</span>

  <span class="doc">(**</span><span class="doc"> The files ops *)</span>
  <span class="governing">mod</span><span class="governing">ule</span> <span class="module">Files</span> <span class="operator">=</span> <span class="governing">struct</span>
    <span class="governing">open </span><span class="module">File</span>
    <span class="governing">let</span> <span class="variable-name">files</span> <span class="operator">=</span> <span class="operator">{</span>
      find<span class="operator">=(</span><span class="keyword">fun</span> <span class="variable-name">fid</span> <span class="operator">-&gt;</span> <span class="module">File.</span>file_ops <span class="operator">~</span>fid<span class="operator">);</span>
      create<span class="operator">=(</span><span class="keyword">fun</span> <span class="variable-name">fid times</span> <span class="operator">-&gt;</span> 
          <span class="governing">let</span> <span class="variable-name">perm</span> <span class="operator">=</span> <span class="module">Tjr_file.</span>default_create_perm <span class="governing">in</span>
          <span class="comment-delimiter">(* </span><span class="comment">FIXME we assume it doesn't already exist </span><span class="comment-delimiter">*)</span>
          from_lwt <span class="module">Lwt_unix.</span><span class="operator">(</span>openfile <span class="operator">(</span>fn fid<span class="operator">)</span> <span class="operator">[</span><span class="constructor">O_CREAT</span><span class="operator">;</span><span class="constructor">O_RDWR</span><span class="operator">]</span> perm<span class="operator">)</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">fd</span> <span class="operator">-&gt;</span>
          from_lwt <span class="module">Lwt_unix.</span><span class="operator">(</span>close fd<span class="operator">)</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="operator">()</span> <span class="operator">-&gt;</span>
          <span class="comment-delimiter">(* </span><span class="comment">we also have to create a root block </span><span class="comment-delimiter">*)</span>
          blk_alloc.blk_alloc <span class="operator">()</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">blk_id</span> <span class="operator">-&gt;</span>
          write_rb <span class="operator">~</span>blk_id <span class="operator">{</span> times <span class="operator">}</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="operator">()</span> <span class="operator">-&gt;</span>
          <span class="comment-delimiter">(* </span><span class="comment">and insert into gom </span><span class="comment-delimiter">*)</span>
          gom_insert <span class="operator">(</span><span class="constructor">Fid</span> fid<span class="operator">)</span> blk_id
        <span class="operator">);</span>
      <span class="comment-delimiter">(* </span><span class="comment">delete=(fun fid -&gt; gom_delete (Fid fid)) (\** NOTE no gc *\) </span><span class="comment-delimiter">*)</span>
    <span class="operator">}</span>

  <span class="governing">end</span>
  <span class="governing">let</span> <span class="variable-name">files</span><span class="operator">:</span> <span class="type">files_ops </span><span class="operator">=</span> <span class="module">Files.</span>files

  <span class="doc">(**</span><span class="doc"> Extra ops *)</span>
  <span class="governing">let</span> <span class="variable-name">ext</span><span class="variable-name">ra</span> <span class="operator">:</span> <span class="type">extra_ops </span><span class="operator">=</span> <span class="operator">{</span>
    internal_err<span class="operator">=(</span><span class="keyword">fun</span> <span class="variable-name">s</span> <span class="operator">-&gt;</span> <span class="builtin">failwith</span> s<span class="operator">);</span>  <span class="comment-delimiter">(* </span><span class="comment">FIXME </span><span class="comment-delimiter">*)</span>
    is_ancestor<span class="operator">=</span><span class="operator">(</span><span class="keyword">fun</span> <span class="label">~parent</span><span class="operator">:</span><span class="variable-name">_ </span><span class="label">~child</span><span class="operator">:</span><span class="variable-name">_</span> <span class="operator">-&gt;</span> return <span class="constant">false</span><span class="operator">)</span> <span class="comment-delimiter">(* </span><span class="comment">FIXME </span><span class="comment-delimiter">*)</span>
  <span class="operator">}</span>

  <span class="doc">(** create_dir, create_file and create_symlink *)</span>
      
  <span class="attribute">[@@@warning </span><span class="string">&quot;-27&quot;</span><span class="attribute">]</span>

  <span class="governing">let</span> <span class="function-name">create_file</span><span class="variable-name"> </span><span class="operator">~</span><span class="variable-name">parent </span><span class="operator">~</span><span class="variable-name">name </span><span class="operator">~</span><span class="variable-name">times</span> <span class="operator">=</span> 
    new_fid <span class="operator">()</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">fid</span> <span class="operator">-&gt;</span> 
    files.create fid times <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="operator">()</span> <span class="operator">-&gt;</span>
    dirs.find parent <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">dir</span> <span class="operator">-&gt;</span>
    dir.insert name <span class="operator">(</span><span class="constructor">Fid</span> fid<span class="operator">)</span>
      
  <span class="governing">l</span><span class="governing">et</span> <span class="function-name">create_dir</span><span class="variable-name"> </span><span class="operator">~</span><span class="variable-name">parent </span><span class="operator">~</span><span class="variable-name">name </span><span class="operator">~</span><span class="variable-name">times</span> <span class="operator">=</span> 
    new_did <span class="operator">()</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">did</span> <span class="operator">-&gt;</span>
    blk_alloc.blk_alloc <span class="operator">()</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">blk_id</span> <span class="operator">-&gt;</span>
    blk_alloc.blk_alloc <span class="operator">()</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">map_root</span> <span class="operator">-&gt;</span>
    <span class="comment-delimiter">(* </span><span class="comment">initialize the empty leaf blk </span><span class="comment-delimiter">*)</span>
    <span class="module">Dir.</span>write_empty_leaf <span class="label">~blk_id</span><span class="operator">:</span>map_root <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="operator">()</span> <span class="operator">-&gt;</span>
    <span class="comment-delimiter">(* </span><span class="comment">write the root block itself </span><span class="comment-delimiter">*)</span>
    <span class="module">Dir.</span><span class="operator">(</span>write_rb <span class="operator">~</span>blk_id <span class="operator">{</span> map_root<span class="operator">;</span> parent<span class="operator">;</span> times <span class="operator">})</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="operator">()</span> <span class="operator">-&gt;</span>
    <span class="comment-delimiter">(* </span><span class="comment">add new dir to parent </span><span class="comment-delimiter">*)</span>
    dirs.find parent <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">dir</span> <span class="operator">-&gt;</span>
    dir.insert name <span class="operator">(</span><span class="constructor">Did</span> did<span class="operator">)</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="operator">()</span> <span class="operator">-&gt;</span>
    return <span class="operator">()</span>

  <span class="governing">module</span> <span class="module">Symlink</span> <span class="operator">=</span> <span class="governing">struct</span>
    <span class="governing">module</span> <span class="module">Rb</span> <span class="operator">=</span> <span class="governing">struct</span> <span class="governing">open </span><span class="module">Str_256</span> <span class="governing">type</span> <span class="type">rb</span><span class="operator">={</span>contents<span class="operator">:</span>str_256<span class="operator">}</span><span class="attribute">[@@deriving bin_io]</span> <span class="governing">end</span>
    <span class="governing">include</span> <span class="module">Make_root_blk_ops</span><span class="operator">(</span><span class="module">Rb</span><span class="operator">)</span>
  <span class="governing">end</span>

  <span class="governing">let</span> <span class="function-name">create_symlink</span><span class="variable-name"> </span><span class="operator">~</span><span class="variable-name">parent </span><span class="operator">~</span><span class="variable-name">name </span><span class="operator">~</span><span class="variable-name">times </span><span class="operator">~</span><span class="variable-name">contents</span> <span class="operator">=</span> 
    new_sid <span class="operator">()</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">sid</span> <span class="operator">-&gt;</span>
    blk_alloc.blk_alloc <span class="operator">()</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">blk_id</span> <span class="operator">-&gt;</span>
    <span class="module">Symlink.</span>write_rb <span class="operator">~</span>blk_id <span class="operator">{</span>contents<span class="operator">}</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="operator">()</span> <span class="operator">-&gt;</span>
    <span class="comment-delimiter">(* </span><span class="comment">add new symlink to parent </span><span class="comment-delimiter">*)</span>
    dirs.find parent <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">dir</span> <span class="operator">-&gt;</span>
    dir.insert name <span class="operator">(</span><span class="constructor">Sid</span> sid<span class="operator">)</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="operator">()</span> <span class="operator">-&gt;</span>
    return <span class="operator">()</span>
  <span class="comment-delimiter">(* </span><span class="comment">FIXME we also need readlink to be implemented properly - see path res </span><span class="comment-delimiter">*)</span>
      
  <span class="governing">let</span> <span class="function-name">read_symlink</span><span class="variable-name"> sid</span> <span class="operator">=</span> 
    gom_find <span class="operator">(</span><span class="constructor">Sid</span> sid<span class="operator">)</span> <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">blk_id</span> <span class="operator">-&gt;</span>
    <span class="module">Symlink.</span>read_rb <span class="operator">~</span>blk_id <span class="operator">&gt;&gt;=</span> <span class="keyword">fun</span> <span class="variable-name">rb</span> <span class="operator">-&gt;</span>
    return rb.contents

  <span class="comment-delimiter">(* </span><span class="comment">patch the prior ref at runtime, to avoid reordering adn mutual
     dependency between create_symlink and Dir </span><span class="comment-delimiter">*)</span>
  <span class="governing">let</span> <span class="variable-name">_</span> <span class="operator">=</span> <span class="module">Dir.</span>read_symlink <span class="operator">:=</span> read_symlink


  <span class="doc">(</span><span class="doc">** {2 Instantiate filesystem} *)</span>
  <span class="governing">module</span> <span class="module">X</span> <span class="operator">=</span> <span class="governing">struct</span>
    <span class="governing">let</span> <span class="variable-name">root_did</span> <span class="operator">=</span> root_did
    <span class="governing">let</span> <span class="variable-name">dirs</span> <span class="operator">=</span> dirs
    <span class="governing">let</span> <span class="variable-name">files</span> <span class="operator">=</span> files
    <span class="governing">let</span> <span class="variable-name">resolve_path</span> <span class="operator">=</span> resolve_path
    <span class="governing">let</span> <span class="variable-name">mk_stat_times</span> <span class="operator">=</span> mk_stat_times
    <span class="governing">let</span> <span class="variable-name">extra</span> <span class="operator">=</span> extra
    <span class="governing">let</span> <span class="variable-name">create_dir</span> <span class="operator">=</span> create_dir
    <span class="governing">let</span> <span class="variable-name">create_file</span> <span class="operator">=</span> create_file
    <span class="governing">let</span> <span class="variable-name">create_symlink</span> <span class="operator">=</span> create_symlink
  <span class="governing">end</span>
  <span class="governing">module</span> <span class="module">The_filesystem</span> <span class="operator">=</span> <span class="module">Make_2</span><span class="operator">(</span><span class="module">X</span><span class="operator">)</span>

<span class="governing">end</span>
</pre>

 </body>
</html>
