<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Tjr_impfs_v1__V1 (tjr_impfs_v1.Tjr_impfs_v1__V1)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../index.html">tjr_impfs_v1</a> &#x00BB; Tjr_impfs_v1__V1</nav><h1>Module <code>Tjr_impfs_v1__V1</code></h1><p>V1 - implement directories and file metadata, with file data passed through to an underlying filesystem.</p><p>We have a single &quot;global object map&quot;, which maps ids (ints) to either dir-roots, or file-meta, or symlinks.</p><p>NOTE much of this is based on <span class="xref-unresolved" title="unresolved reference to &quot;Tjr_minifs.In_mem&quot;"><code>Tjr_minifs</code>.In_mem</span>, but with on-disk maps, rather than in-memory.</p><nav class="toc"><ul><li><a href="#setup-the-generic-instance">Setup the generic instance</a></li><li><a href="#some-simple-defns-we-can-complete-here">Some simple defns we can complete here</a></li><li><a href="#implement-definitions-from-t2,-ie,-the-core-filesystem">Implement definitions from T2, ie, the core filesystem</a></li><li><a href="#various-marshallers">Various marshallers</a></li><li><a href="#various-runtime-components-that-get-filled-in-later">Various runtime components that get filled in later</a></li><li><a href="#the-global-object-map-(gom)">The global object map (GOM)</a></li><li><a href="#definitions-after-the-gom-has-been-initialized">Definitions after the GOM has been initialized</a></li></ul></nav></header><div class="spec module" id="module-G"><a href="#module-G" class="anchor"></a><code><span class="keyword">module</span> G = <a href="../Tjr_impfs_v1/index.html#module-Generic">Tjr_impfs_v1.Generic</a></code></div><dl><dt class="spec type" id="type-uncached_btree"><a href="#type-uncached_btree" class="anchor"></a><code><span class="keyword">type</span> <span>('k, 'v, 't) uncached_btree</span></code><code> = <span><span>(<span class="type-var">'k</span>, <span class="type-var">'v</span>, <span class="type-var">'t</span>)</span> Tjr_btree.Make_3.uncached_btree</span></code></dt></dl><dl><dt class="spec value" id="val-buf_create"><a href="#val-buf_create" class="anchor"></a><code><span class="keyword">val</span> buf_create : unit <span>&#45;&gt;</span> Tjr_fs_shared__.Buf_factory.Buf_as_bigarray.ba_buf</code></dt><dt class="spec value" id="val-s256_to_string"><a href="#val-s256_to_string" class="anchor"></a><code><span class="keyword">val</span> s256_to_string : Tjr_fs_shared.str_256 <span>&#45;&gt;</span> string</code></dt></dl><section><header><h3 id="setup-the-generic-instance"><a href="#setup-the-generic-instance" class="anchor"></a>Setup the generic instance</h3></header><dl><dt class="spec module" id="module-S0"><a href="#module-S0" class="anchor"></a><code><span class="keyword">module</span> <a href="S0/index.html">S0</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>Base types</p></dd></dl><div class="spec module" id="module-Make"><a href="#module-Make" class="anchor"></a><code><span class="keyword">module</span> <a href="Make/index.html">Make</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec module" id="module-S1"><a href="#module-S1" class="anchor"></a><code><span class="keyword">module</span> S1 = <a href="Make/index.html#module-S1">Make.S1</a></code></dt><dd><p>derived types</p></dd></dl><dl><dt class="spec module" id="module-S2"><a href="#module-S2" class="anchor"></a><code><span class="keyword">module</span> S2 = <a href="Make/index.html#module-S2">Make.S2</a></code></dt><dd><p>functor argument type holder</p></dd></dl><dl><dt class="spec module-type" id="module-type-T2"><a href="#module-type-T2" class="anchor"></a><code><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-T2/index.html">T2</a> = <a href="Make/S2/index.html#module-type-T2">S2.T2</a></code></dt><dd><p>what we need to provide to get a filesystem</p></dd></dl><dl><dt class="spec module" id="module-Make_2"><a href="#module-Make_2" class="anchor"></a><code><span class="keyword">module</span> Make_2 = <a href="Make/index.html#module-Make_2">Make.Make_2</a></code></dt><dd><p>functor to construct a filesystem (takes a module of type T2); the implementation is <code>T2_impl</code>, towards the end of this file</p></dd></dl></section><section><header><h3 id="some-simple-defns-we-can-complete-here"><a href="#some-simple-defns-we-can-complete-here" class="anchor"></a>Some simple defns we can complete here</h3></header><dl><dt class="spec value" id="val-root_did"><a href="#val-root_did" class="anchor"></a><code><span class="keyword">val</span> root_did : <a href="S0/index.html#type-did">S0.did</a></code></dt><dt class="spec value" id="val-mk_stat_times"><a href="#val-mk_stat_times" class="anchor"></a><code><span class="keyword">val</span> mk_stat_times : unit <span>&#45;&gt;</span> <span><span>(<a href="../Tjr_impfs_v1/Generic/index.html#type-stat_times">G.stat_times</a>, Tjr_monad.With_lwt.lwt)</span> Tjr_monad.m</span></code></dt></dl></section><section><header><h3 id="implement-definitions-from-t2,-ie,-the-core-filesystem"><a href="#implement-definitions-from-t2,-ie,-the-core-filesystem" class="anchor"></a>Implement definitions from T2, ie, the core filesystem</h3></header><dl><dt class="spec type" id="type-obj_root"><a href="#type-obj_root" class="anchor"></a><code><span class="keyword">type</span> obj_root</code><code> = Tjr_fs_shared.Std_types.blk_id</code></dt></dl><div><div class="spec include"><div class="doc"><dl><dt class="spec value" id="val-bin_shape_obj_root"><a href="#val-bin_shape_obj_root" class="anchor"></a><code><span class="keyword">val</span> bin_shape_obj_root : Bin_prot.Shape.t</code></dt><dt class="spec value" id="val-bin_size_obj_root"><a href="#val-bin_size_obj_root" class="anchor"></a><code><span class="keyword">val</span> bin_size_obj_root : <span><a href="index.html#type-obj_root">obj_root</a> Bin_prot.Size.sizer</span></code></dt><dt class="spec value" id="val-bin_write_obj_root"><a href="#val-bin_write_obj_root" class="anchor"></a><code><span class="keyword">val</span> bin_write_obj_root : <span><a href="index.html#type-obj_root">obj_root</a> Bin_prot.Write.writer</span></code></dt><dt class="spec value" id="val-bin_writer_obj_root"><a href="#val-bin_writer_obj_root" class="anchor"></a><code><span class="keyword">val</span> bin_writer_obj_root : <span><a href="index.html#type-obj_root">obj_root</a> Bin_prot.Type_class.writer</span></code></dt><dt class="spec value" id="val-__bin_read_obj_root__"><a href="#val-__bin_read_obj_root__" class="anchor"></a><code><span class="keyword">val</span> __bin_read_obj_root__ : <span><span>(int <span>&#45;&gt;</span> <a href="index.html#type-obj_root">obj_root</a>)</span> Bin_prot.Read.reader</span></code></dt><dt class="spec value" id="val-bin_read_obj_root"><a href="#val-bin_read_obj_root" class="anchor"></a><code><span class="keyword">val</span> bin_read_obj_root : <span><a href="index.html#type-obj_root">obj_root</a> Bin_prot.Read.reader</span></code></dt><dt class="spec value" id="val-bin_reader_obj_root"><a href="#val-bin_reader_obj_root" class="anchor"></a><code><span class="keyword">val</span> bin_reader_obj_root : <span><a href="index.html#type-obj_root">obj_root</a> Bin_prot.Type_class.reader</span></code></dt><dt class="spec value" id="val-bin_obj_root"><a href="#val-bin_obj_root" class="anchor"></a><code><span class="keyword">val</span> bin_obj_root : <span><a href="index.html#type-obj_root">obj_root</a> Bin_prot.Type_class.t</span></code></dt></dl></div></div></div><dl><dt class="spec type" id="type-dir_entry"><a href="#type-dir_entry" class="anchor"></a><code><span class="keyword">type</span> dir_entry</code><code> = <a href="Make/S1/index.html#type-dir_entry">S1.dir_entry</a></code></dt></dl></section><section><header><h3 id="various-marshallers"><a href="#various-marshallers" class="anchor"></a>Various marshallers</h3></header><div class="spec module" id="module-Ms"><a href="#module-Ms" class="anchor"></a><code><span class="keyword">module</span> <a href="Ms/index.html">Ms</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div></section><section><header><h3 id="various-runtime-components-that-get-filled-in-later"><a href="#various-runtime-components-that-get-filled-in-later" class="anchor"></a>Various runtime components that get filled in later</h3></header><dl><dt class="spec value" id="val-blk_dev_ref"><a href="#val-blk_dev_ref" class="anchor"></a><code><span class="keyword">val</span> blk_dev_ref : <span><span><span><span>(Tjr_fs_shared.Std_types.blk_id, Tjr_fs_shared.Std_types.blk, Tjr_fs_shared.Std_types.t)</span> Tjr_fs_shared.blk_dev_ops</span> option</span> Stdlib.ref</span></code></dt><dt class="spec value" id="val-blk_dev_ops"><a href="#val-blk_dev_ops" class="anchor"></a><code><span class="keyword">val</span> blk_dev_ops : <span><span><span>(Tjr_fs_shared.Std_types.blk_id, Tjr_fs_shared.Std_types.blk, Tjr_fs_shared.Std_types.t)</span> Tjr_fs_shared.blk_dev_ops</span> Stdlib.Lazy.t</span></code></dt><dt class="spec value" id="val-blk_alloc_ref"><a href="#val-blk_alloc_ref" class="anchor"></a><code><span class="keyword">val</span> blk_alloc_ref : <span><span><span><span>(Tjr_fs_shared.Std_types.blk_id, Tjr_fs_shared.Std_types.t)</span> Tjr_fs_shared.blk_allocator_ops</span> option</span> Stdlib.ref</span></code></dt><dt class="spec value" id="val-blk_alloc"><a href="#val-blk_alloc" class="anchor"></a><code><span class="keyword">val</span> blk_alloc : <span><span><span>(Tjr_fs_shared.Std_types.blk_id, Tjr_fs_shared.Std_types.t)</span> Tjr_fs_shared.blk_allocator_ops</span> Stdlib.Lazy.t</span></code></dt><dt class="spec value" id="val-root_ops_ref"><a href="#val-root_ops_ref" class="anchor"></a><code><span class="keyword">val</span> root_ops_ref : <span><span><span><span>(Tjr_fs_shared.Std_types.blk_id, Tjr_fs_shared.Std_types.t)</span> Tjr_monad.with_state</span> option</span> Stdlib.ref</span></code></dt><dt class="spec value" id="val-root_ops"><a href="#val-root_ops" class="anchor"></a><code><span class="keyword">val</span> root_ops : <span><span><span>(Tjr_fs_shared.Std_types.blk_id, Tjr_fs_shared.Std_types.t)</span> Tjr_monad.with_state</span> Stdlib.Lazy.t</span></code></dt><dt class="spec value" id="val-min_free_id_ref"><a href="#val-min_free_id_ref" class="anchor"></a><code><span class="keyword">val</span> min_free_id_ref : <span>int Stdlib.ref</span></code></dt><dd><p>We use mutually exclusive subsets of int for identifiers</p></dd></dl><dl><dt class="spec value" id="val-new_id"><a href="#val-new_id" class="anchor"></a><code><span class="keyword">val</span> new_id : unit <span>&#45;&gt;</span> <span><span>(int, Tjr_monad.With_lwt.lwt)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-new_did"><a href="#val-new_did" class="anchor"></a><code><span class="keyword">val</span> new_did : unit <span>&#45;&gt;</span> <span><span>(<a href="S0/index.html#type-did">S0.did</a>, Tjr_monad.With_lwt.lwt)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-new_fid"><a href="#val-new_fid" class="anchor"></a><code><span class="keyword">val</span> new_fid : unit <span>&#45;&gt;</span> <span><span>(<a href="S0/index.html#type-fid">S0.fid</a>, Tjr_monad.With_lwt.lwt)</span> Tjr_monad.m</span></code></dt><dt class="spec value" id="val-new_sid"><a href="#val-new_sid" class="anchor"></a><code><span class="keyword">val</span> new_sid : unit <span>&#45;&gt;</span> <span><span>(<a href="S0/index.html#type-sid">S0.sid</a>, Tjr_monad.With_lwt.lwt)</span> Tjr_monad.m</span></code></dt></dl></section><section><header><h3 id="the-global-object-map-(gom)"><a href="#the-global-object-map-(gom)" class="anchor"></a>The global object map (GOM)</h3></header><div class="spec module" id="module-Gom"><a href="#module-Gom" class="anchor"></a><code><span class="keyword">module</span> <a href="Gom/index.html">Gom</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec value" id="val-gom_btree"><a href="#val-gom_btree" class="anchor"></a><code><span class="keyword">val</span> gom_btree : <span><span><span>(<a href="Gom/index.html#type-k">Gom.k</a>, <a href="Gom/index.html#type-v">Gom.v</a>, <a href="S0/index.html#type-t">S0.t</a>)</span> <a href="index.html#type-uncached_btree">uncached_btree</a></span> Stdlib.Lazy.t</span></code></dt></dl></section><section><header><h3 id="definitions-after-the-gom-has-been-initialized"><a href="#definitions-after-the-gom-has-been-initialized" class="anchor"></a>Definitions after the GOM has been initialized</h3></header><dl><dt class="spec module" id="module-With_gom"><a href="#module-With_gom" class="anchor"></a><code><span class="keyword">module</span> <a href="With_gom/index.html">With_gom</a> : <span class="keyword">functor</span> () <span class="keyword">sig</span> ... <span class="keyword">end</span></code></dt><dd><p>NOTE Instantiate this after gom_btree has been initialized</p></dd></dl></section></div></body></html>